// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

import {Script, console2} from "forge-std/Script.sol";
import {Test} from "forge-std/Test.sol";
import {AuctionParameters} from "@twap-auction/interfaces/IContinuousClearingAuction.sol";

import {Tick} from "@twap-auction/interfaces/ITickStorage.sol";

import {FixedPoint96} from "@twap-auction/libraries/FixedPoint96.sol";

// Token launcher
import {ILiquidityLauncher} from "@launcher/interfaces/ILiquidityLauncher.sol";
import {IPoolManager} from "@v4c/interfaces/IPoolManager.sol";
import {MigratorParameters} from "@launcher/types/MigratorParameters.sol";
import {Distribution} from "@launcher/types/Distribution.sol";
import {IAllowanceTransfer} from "@launcher/Permit2Forwarder.sol";
import {IDistributionContract} from "@launcher/interfaces/IDistributionContract.sol";
import {IVirtualLBPStrategyBasic} from "src/uniswap-periphery/IVirtualLBPStrategyBasic.sol";
import {IVirtualLBPStrategyFactory} from "src/uniswap-periphery/IVirtualLBPStrategyFactory.sol";
import {IRegistry, StakerVersion} from "@atp/Registry.sol";

// ContinuousClearingAuction factory
import {IContinuousClearingAuctionFactory} from "@twap-auction/interfaces/IContinuousClearingAuctionFactory.sol";
import {IContinuousClearingAuction} from "@twap-auction/interfaces/IContinuousClearingAuction.sol";
import {AuctionStepsBuilder} from "@twap-auction-test/utils/AuctionStepsBuilder.sol";
import {ConstantsLib} from "@twap-auction/libraries/ConstantsLib.sol";

// v4
import {IPositionManager} from "@v4p/interfaces/IPositionManager.sol";
import {ActionConstants} from "@v4p/libraries/ActionConstants.sol";

// Permit2
import {IPermit2} from "@launcher/../lib/permit2/src/interfaces/IPermit2.sol";

// Salt generator
import {SaltGenerator} from "test/integration/LauncherSaltGenerator.sol";

import {FoundationWallets} from "../CollectiveDeploy.s.sol";
import {GovernanceAcceleratedLock} from "src/uniswap-periphery/GovernanceAcceleratedLock.sol";

// Internal
import {AztecAuctionHook} from "src/uniswap-periphery/AuctionHook.sol";
import {IIgnitionParticipantSoulbound} from "src/soulbound/IIgnitionParticipantSoulbound.sol";
import {PredicateProvider} from "src/soulbound/providers/PredicateProvider.sol";
import {IWhitelistProvider} from "src/soulbound/providers/IWhitelistProvider.sol";
import {MockPredicateProvider} from "test/mocks/MockPredicateProvider.sol";
import {VirtualAztecToken} from "src/uniswap-periphery/VirtualAztecToken.sol";
import {ATPFactory} from "@atp/ATPFactory.sol";
import {ATPFactoryNonces, IATPFactoryNonces} from "@atp/ATPFactoryNonces.sol";
import {IERC20} from "@oz/token/ERC20/IERC20.sol";

import {Ownable} from "@oz/access/Ownable.sol";
import {Ownable2Step} from "@oz/access/Ownable2Step.sol";

import {
    AuctionConfiguration,
    PredicateConfiguration,
    VirtualAztecTokenConfiguration,
    AtpFactoryConfiguration,
    StrategyConfiguration,
    TokenSplits,
    TokenLauncherConfiguration,
    TwapConfig
} from "./AuctionConfiguration.sol";
import {ConfigurationVariant, ChainEnvironment} from "../SharedConfig.sol";

interface IERC20Mintable {
    function mint(address _to, uint256 _amount) external;
}

contract DeployAuction is Test {
    using AuctionStepsBuilder for bytes;

    struct DeployedAuctionContracts {
        address governanceAddress;
        address protocolTreasuryAddress;
        // intermediates
        bytes32 generatedSalt;
        address predictedVirtualLBPAddress;
        address predictedAuctionAddress;
        // deployed addresses
        address soulbound;
        address stakingAssetAddress;
        address genesisSequencerSale;
        address auctionFactory;
        address auctionHook;
        address predicateAuctionScreeningProvider;
        address atpFactoryAuction;
        address atpRegistryAuction;
        address virtualAztecToken;
        address auction;
        uint256 startBlock;
        address tokenLauncher;
        address virtualLBPFactory;
        address dateGatedRelayerShort;
        // address virtualLBP;
        address permit2;
        Distribution distributionParams;
        uint128 tokenLauncherTotalSupply;
        address foundationPayload;
        address atpWithdrawableAndClaimableStaker;
    }

    AuctionConfiguration internal CONFIGURATION;
    FoundationWallets internal WALLETS;
    ChainEnvironment internal CHAIN_ENVIRONMENT;
    DeployedAuctionContracts internal deployedContracts;

    function getDeployedContracts() public view returns (DeployedAuctionContracts memory) {
        return deployedContracts;
    }

    function setEnv(
        ConfigurationVariant _configurationVariant,
        FoundationWallets memory _foundationWallets,
        ChainEnvironment _chainEnvironment,
        address _governanceAddress,
        address _stakingAssetAddress,
        address _foundationPayload,
        address _protocolTreasuryAddress,
        address _genesisSequencerSale,
        address _soulbound,
        address _atpWithdrawableAndClaimableStaker
    ) public {
        CONFIGURATION = new AuctionConfiguration(_configurationVariant);
        WALLETS = _foundationWallets;
        CHAIN_ENVIRONMENT = _chainEnvironment;
        deployedContracts.governanceAddress = _governanceAddress;
        deployedContracts.protocolTreasuryAddress = _protocolTreasuryAddress;
        deployedContracts.stakingAssetAddress = _stakingAssetAddress;
        deployedContracts.foundationPayload = _foundationPayload;
        deployedContracts.genesisSequencerSale = _genesisSequencerSale;
        deployedContracts.soulbound = _soulbound;
        deployedContracts.atpWithdrawableAndClaimableStaker = _atpWithdrawableAndClaimableStaker;
    }

    function run() external {
        deployAuction();

        assertions();
    }

    struct UniParameters {
        AuctionParameters auctionParams;
        MigratorParameters migratorParams;
        Distribution distributionParams;
    }

    // @todo- can only run on mainnet fork
    function deployAuction() public {
        // Initialize the struct with input parameters
        // Deploy the auction factory
        IContinuousClearingAuctionFactory auctionFactory = IContinuousClearingAuctionFactory(0x0000ccaDF55C911a2FbC0BB9d2942Aa77c6FAa1D);
        deployedContracts.auctionFactory = address(auctionFactory);

        TokenLauncherConfiguration memory tokenLauncherConfiguration = CONFIGURATION.getTokenLauncherConfiguration();
        deployedContracts.permit2 = tokenLauncherConfiguration.permit2;
        // Token launcher
        deployedContracts.tokenLauncher = address(0x00000008412db3394C91A5CbD01635c6d140637C);

        {
            uint256 gatedRelayerStart = CONFIGURATION.getGatedRelayerStart();
            vm.broadcast(WALLETS.deployer);
            deployedContracts.dateGatedRelayerShort =
                address(new GovernanceAcceleratedLock(deployedContracts.governanceAddress, gatedRelayerStart));
        }

        // Deploy the strategy factory
        StrategyConfiguration memory strategyConfiguration = CONFIGURATION.getStrategyConfiguration();
        if (block.chainid == 11155111) {
            deployedContracts.virtualLBPFactory = address(0xC695ee292c39Be6a10119C70Ed783d067fcecfA4);
        } else {
            deployedContracts.virtualLBPFactory = address(0x00000010F37b6524617b17e66796058412bbC487);
        }
        console2.log("virtual lbp code exists", address(deployedContracts.virtualLBPFactory).code.length > 0);
        console2.log("liquidity factory exists", address(deployedContracts.tokenLauncher).code.length > 0);
        console2.log("auction factory exists", address(deployedContracts.auctionFactory).code.length > 0);

        emit log_named_address("virtualLBPFactory", deployedContracts.virtualLBPFactory);
        emit log_named_address("liquidityLauncher", deployedContracts.tokenLauncher);
        emit log_named_address("auctionFactory", deployedContracts.auctionFactory);

        // Deploy the auction address screening provider
        IWhitelistProvider predicateAuctionScreeningProvider;
        // If we are running locally, we use a mock provider
        if (block.chainid == 31337) {
            PredicateConfiguration memory predicateConfiguration = CONFIGURATION.getPredicateConfiguration();
            vm.broadcast(WALLETS.deployer);
            predicateAuctionScreeningProvider = new MockPredicateProvider(
                WALLETS.deployer, predicateConfiguration.managerAddress, predicateConfiguration.addressScreeningPolicyId
            );
            // If on a real chain we use a predicate provider
        } else if (CHAIN_ENVIRONMENT == ChainEnvironment.FORKED_MAINNET) {
            predicateAuctionScreeningProvider = IWhitelistProvider(0xf5A7405C39cC72751fdd2E357Bd9AD8f22514950);
        } else {
            PredicateConfiguration memory predicateConfiguration = CONFIGURATION.getPredicateConfiguration();
            vm.broadcast(WALLETS.deployer);
            predicateAuctionScreeningProvider = new PredicateProvider(
                WALLETS.deployer, predicateConfiguration.managerAddress, predicateConfiguration.addressScreeningPolicyId
            );
        }

        // Deploy one single ATP factory for the virtual aztec token
        {
            AtpFactoryConfiguration memory atpFactoryConfiguration = CONFIGURATION.getAtpFactoryConfiguration();

            vm.broadcast(WALLETS.deployer);
            ATPFactoryNonces atpFactory = new ATPFactoryNonces(
                WALLETS.deployer,
                IERC20(deployedContracts.stakingAssetAddress),
                atpFactoryConfiguration.unlockCliffDuration,
                atpFactoryConfiguration.unlockLockDuration
            );
            deployedContracts.atpFactoryAuction = address(atpFactory);
            IRegistry registry = atpFactory.getRegistry();
            deployedContracts.atpRegistryAuction = address(registry);

            vm.broadcast(WALLETS.deployer);
            registry.registerStakerImplementation(address(deployedContracts.atpWithdrawableAndClaimableStaker));

            vm.broadcast(WALLETS.deployer);
            registry.setExecuteAllowedAt(atpFactoryConfiguration.executionAllowedAt);

            // We set the unlockStart time to be the time in which the GovernanceAcceleratedLock is to begin
            uint256 gatedRelayerStart = CONFIGURATION.getGatedRelayerStart();
            vm.broadcast(WALLETS.deployer);
            registry.setUnlockStartTime(gatedRelayerStart);
        }

        // Deploy the Virtual Aztec Token
        {
            VirtualAztecTokenConfiguration memory virtualAztecTokenConfiguration =
                CONFIGURATION.getVirtualAztecTokenConfiguration();
            vm.broadcast(WALLETS.deployer);
            VirtualAztecToken virtualAztecToken = new VirtualAztecToken(
                virtualAztecTokenConfiguration.name,
                virtualAztecTokenConfiguration.symbol,
                IERC20(deployedContracts.stakingAssetAddress),
                IATPFactoryNonces(address(deployedContracts.atpFactoryAuction)),
                WALLETS.twapTokenRecipient
            );
            deployedContracts.virtualAztecToken = address(virtualAztecToken);
        }

        {
            if (CHAIN_ENVIRONMENT == ChainEnvironment.FORKED_MAINNET) {
                vm.broadcast(0xE9BDCB32279186b8CaAD1A7Cc6E1044e71359F49);
                PredicateProvider(address(predicateAuctionScreeningProvider)).transferOwnership(WALLETS.deployer);
            }
            vm.broadcast(WALLETS.deployer);
            predicateAuctionScreeningProvider.setConsumer(address(deployedContracts.virtualAztecToken));
            deployedContracts.predicateAuctionScreeningProvider = address(predicateAuctionScreeningProvider);
        }

        UniParameters memory uniParams;
        {
            console2.log("Creating auction parameters");
            TwapConfig memory twapConfig = CONFIGURATION.getTwapConfig();
            TokenSplits memory tokenSplits = CONFIGURATION.getTokenSplits();

            deployedContracts.tokenLauncherTotalSupply = tokenSplits.totalSupply;
            deployedContracts.startBlock = twapConfig.startBlock;

            // Deploy the auction hook
            vm.broadcast(WALLETS.deployer);
            AztecAuctionHook auctionHook = new AztecAuctionHook(
                IIgnitionParticipantSoulbound(deployedContracts.soulbound),
                twapConfig.auctionHookConfiguration.contributorPeriodBlockEnd
            );
            deployedContracts.auctionHook = address(auctionHook);

            uniParams.auctionParams = AuctionParameters({
                currency: address(0),
                tokensRecipient: WALLETS.twapTokenRecipient,
                fundsRecipient: address(ActionConstants.MSG_SENDER), // MSG_SENDER will be the virtual LBP strategy
                startBlock: uint64(twapConfig.startBlock),
                endBlock: uint64(twapConfig.endBlock),
                claimBlock: uint64(twapConfig.claimBlock),
                floorPrice: twapConfig.floorPrice,
                tickSpacing: twapConfig.tickSpacing,
                validationHook: address(deployedContracts.auctionHook),
                requiredCurrencyRaised: 0,
                auctionStepsData: twapConfig.auctionStepsData
            });

            uniParams.migratorParams = MigratorParameters({
                migrationBlock: uint64(twapConfig.migrationBlock),
                currency: address(0),
                poolLPFee: twapConfig.poolLpFee,
                poolTickSpacing: int24(twapConfig.poolTickSpacing),
                tokenSplitToAuction: uint24(tokenSplits.tokensToSplitToAuctionMps),
                auctionFactory: address(deployedContracts.auctionFactory),
                positionRecipient: address(deployedContracts.protocolTreasuryAddress), // The position is gated for 1 year
                sweepBlock: uint64(twapConfig.sweepBlock),
                operator: WALLETS.auctionOperator,
                createOneSidedTokenPosition: false,
                createOneSidedCurrencyPosition: false
            });

            // Distribution parameters
            uniParams.distributionParams = Distribution({
                strategy: address(deployedContracts.virtualLBPFactory),
                amount: tokenSplits.totalSupply,
                // Modified to include the governance address in the distribution params for virtual lbp
                configData: abi.encode(
                    deployedContracts.dateGatedRelayerShort, uniParams.migratorParams, abi.encode(uniParams.auctionParams)
                )
            });
            deployedContracts.distributionParams = uniParams.distributionParams;

            // Get a valid salt for the strategy
            bytes memory virtualLBPStrategyBasicCreationCode = hex'6102a06040526002805460ff1916905534801561001a575f80fd5b5060405161546c38038061546c833981016040819052610039916109c7565b6001600160a01b0382166080528686868686868080610057306101f2565b50610064905085856102e5565b61006e83856104dc565b600161007a8482610bbc565b506001600160a01b0380871660a05260208501511660c0526001600160801b03851661012081905260808501516100b191906105e5565b6001600160801b03166101409081526001600160a01b039283166102405260c085015183166101605284516001600160401b039081166101805260a086015184166101a05260408087015162ffffff1660e0908152606088015160020b61010090815288015186166101c0528701519091166101e052610120860151151561020052940151151561022052508251634d88bd7d60e11b81529251908c169450639b117afa9350600480840193602093508290030181865afa158015610178573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061019c9190610c76565b6001600160a01b039081166102805281166102608190526040519081527fc73be659241aade67e9a059bcf21494955018b213dbd1179054ccf928b13f3b69060200160405180910390a150505050505050610e06565b6102e2816102dd604080516101c0810182525f80825260208201819052918101829052606081018290526080810182905260a0810182905260c0810182905260e08101829052610100810182905261012081018290526101408101829052610160810182905261018081018290526101a081019190915250604080516101c08101825260018082525f60208301819052928201839052606082018390526080820183905260a0820183905260c082015260e08101829052610100810182905261012081018290526101408101829052610160810182905261018081018290526101a081019190915290565b610601565b50565b805f01516001600160401b03168160e001516001600160401b03161161033d5760e0810151815160405163b834dcef60e01b81526001600160401b039283166004820152911660248201526044015b60405180910390fd5b6298968062ffffff16816080015162ffffff161061038457608081015160405163db75a46960e01b815262ffffff9091166004820152629896806024820152604401610334565b6060810151617fff60029190910b13806103a85750600160020b816060015160020b125b156103e1576060810151604051637466e7f360e11b815260029190910b600482015260016024820152617fff6044820152606401610334565b620f424062ffffff16816040015162ffffff161115610429576040808201519051632eae35a760e01b815262ffffff9091166004820152620f42406024820152604401610334565b60c08101516001600160a01b03161580610450575060c08101516001600160a01b03166001145b80610468575060c08101516001600160a01b03166002145b156104975760c0810151604051630864f00d60e01b81526001600160a01b039091166004820152602401610334565b60808101516104b0906001600160801b0384169061082e565b6001600160801b03165f036104d85760405163c9cac51360e01b815260040160405180910390fd5b5050565b5f828060200190518101906104f19190610c91565b60408101519091506001600160a01b031660011461053a57604080820151905163a629a93160e01b81526001600160a01b03909116600482015260016024820152604401610334565b815f01516001600160401b031681608001516001600160401b03161061058d576080810151825160405163120ff99f60e11b81526001600160401b03928316600482015291166024820152604401610334565b81602001516001600160a01b0316815f01516001600160a01b0316146105e05780516020830151604051637abe145160e01b81526001600160a01b03928316600482015291166024820152604401610334565b505050565b5f6105f0838361082e565b6105fa9084610db1565b9392505050565b6106166001600160a01b038316612000610855565b81511515901515141580610646575061063a6001600160a01b038316611000610855565b15158160200151151514155b8061066d57506106616001600160a01b038316610800610855565b15158160400151151514155b8061069457506106886001600160a01b038316610400610855565b15158160600151151514155b806106bb57506106af6001600160a01b038316610200610855565b15158160800151151514155b806106e257506106d66001600160a01b038316610100610855565b15158160a00151151514155b8061070857506106fc6001600160a01b0383166080610855565b15158160c00151151514155b8061072e57506107226001600160a01b0383166040610855565b15158160e00151151514155b8061075557506107486001600160a01b0383166020610855565b1515816101000151151514155b8061077c575061076f6001600160a01b0383166010610855565b1515816101200151151514155b806107a357506107966001600160a01b0383166008610855565b1515816101400151151514155b806107ca57506107bd6001600160a01b0383166004610855565b1515816101600151151514155b806107f157506107e46001600160a01b0383166002610855565b1515816101800151151514155b80610818575061080b6001600160a01b0383166001610855565b1515816101a00151151514155b156104d8576104d8630732d7b560e51b8361086a565b5f6298968061084b62ffffff84166001600160801b038616610dd0565b6105fa9190610de7565b6001600160a01b038282161615155b92915050565b815f526001600160a01b03811660045260245ffd5b6001600160a01b03811681146102e2575f80fd5b805161089e8161087f565b919050565b80516001600160801b038116811461089e575f80fd5b634e487b7160e01b5f52604160045260245ffd5b60405161016081016001600160401b03811182821017156108f0576108f06108b9565b60405290565b80516001600160401b038116811461089e575f80fd5b805162ffffff8116811461089e575f80fd5b8051600281900b811461089e575f80fd5b8051801515811461089e575f80fd5b5f82601f83011261094d575f80fd5b81516001600160401b03811115610966576109666108b9565b604051601f8201601f19908116603f011681016001600160401b0381118282101715610994576109946108b9565b6040528181528382016020018510156109ab575f80fd5b8160208501602083015e5f918101602001919091529392505050565b5f805f805f805f8789036102208112156109df575f80fd5b88516109ea8161087f565b97506109f860208a016108a3565b9650610160603f1982011215610a0c575f80fd5b50610a156108cd565b610a2160408a016108f6565b8152610a2f60608a01610893565b6020820152610a4060808a0161090c565b6040820152610a5160a08a0161091e565b6060820152610a6260c08a0161090c565b6080820152610a7360e08a01610893565b60a0820152610a856101008a01610893565b60c0820152610a976101208a016108f6565b60e0820152610aa96101408a01610893565b610100820152610abc6101608a0161092f565b610120820152610acf6101808a0161092f565b6101408201526101a08901519095506001600160401b03811115610af1575f80fd5b610afd8a828b0161093e565b945050610b0d6101c08901610893565b9250610b1c6101e08901610893565b9150610b2b6102008901610893565b905092959891949750929550565b600181811c90821680610b4d57607f821691505b602082108103610b6b57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156105e057805f5260205f20601f840160051c81016020851015610b965750805b601f840160051c820191505b81811015610bb5575f8155600101610ba2565b5050505050565b81516001600160401b03811115610bd557610bd56108b9565b610be981610be38454610b39565b84610b71565b6020601f821160018114610c1b575f8315610c045750848201515b5f19600385901b1c1916600184901b178455610bb5565b5f84815260208120601f198516915b82811015610c4a5787850151825560209485019460019092019101610c2a565b5084821015610c6757868401515f19600387901b60f8161c191681555b50505050600190811b01905550565b5f60208284031215610c86575f80fd5b81516105fa8161087f565b5f60208284031215610ca1575f80fd5b81516001600160401b03811115610cb6575f80fd5b82016101608185031215610cc8575f80fd5b610cd06108cd565b610cd982610893565b8152610ce760208301610893565b6020820152610cf860408301610893565b6040820152610d09606083016108f6565b6060820152610d1a608083016108f6565b6080820152610d2b60a083016108f6565b60a082015260c08281015190820152610d4660e08301610893565b60e08201526101008281015190820152610d6361012083016108a3565b6101208201526101408201516001600160401b03811115610d82575f80fd5b610d8e8682850161093e565b61014083015250949350505050565b634e487b7160e01b5f52601160045260245ffd5b6001600160801b03828116828216039081111561086457610864610d9d565b808202811582820484141761086457610864610d9d565b5f82610e0157634e487b7160e01b5f52601260045260245ffd5b500490565b60805160a05160c05160e05161010051610120516101405161016051610180516101a0516101c0516101e05161020051610220516102405161026051610280516143c06110ac5f395f818161032c0152818161197f01528181611cd30152611edf01525f81816102760152610a1401525f81816105b4015281816120e50152818161216401528181612208015261224d01525f81816108ac0152611c6101525f818161050c0152611bf901525f81816107f401528181610df001528181610e3601528181611106015261114c01525f818161045001528181610e7401528181610eb601528181610f4e01528181610f750152818161118a015281816111cc01528181611264015261128b01525f818161062d0152610c7d01525f81816103aa0152818161168e01526116d401525f81816106600152611fc601525f818161022601528181610c1d01528181611a9b01528181611c2f015281816129bb01528181612a520152612a9801525f81816102c101528181610a9e01528181610b550152610c3e01525f818161056e01528181611aeb01528181611b1c01528181611e0a0152611f7801525f81816103f501528181611ddf0152611f4d01525f818161087901528181611207015281816112420152818161185701528181611891015281816119b001528181611a7601528181611b4c01528181611b9e01528181611d0b01528181611d4001528181611d7a01528181611da901528181611f0f0152818161212901526121e601525f81816108f801528181610ac901528181610b7701528181610caa01528181610d2801528181610ef101528181610f2c01526120c301525f81816108270152818161092601528181610fe801528181611051015281816110ba015281816113c30152818161142a0152818161148d0152611e4201526143c05ff3fe60806040526004361061020a575f3560e01c8063791b98bc11610113578063c4e833ce1161009d578063e1b4af691161006d578063e1b4af69146106c4578063e5a6b10f14610868578063ecaf76af1461089b578063f6dbee1e146108ce578063fc0c546a146108e7575f80fd5b8063c4e833ce146106e3578063d3decc68146107e3578063dc4c90d314610816578063dc98354e14610849575f80fd5b80639f063efc116100e35780639f063efc146104bc578063abf4fde41461061c578063af7a40ca1461064f578063b47b2fb114610682578063b6a8b0fa146106c4575f80fd5b8063791b98bc146105a35780637c121574146105d65780637d9f6db5146105ea5780638fd3ab8014610608575f80fd5b80634216204411610194578063575e24b411610164578063575e24b4146104725780636c2bbe7e146104bc5780636f0d5e68146104fb5780636fe7e6eb1461053e5780637164cf9b1461055d575f80fd5b806342162044146103995780634b9bf62b146103e4578063532cce181461042b578063570ca7351461043f575f80fd5b8063259982e5116101da578063259982e5146102e357806329db1be61461031b5780632c9dc6ab1461034e578063325564ec1461036f578063331f2f6514610385575f80fd5b806303d41eb614610215578063146278341461026557806318160ddd146102b057806321d0ee70146102e3575f80fd5b3661021157005b5f80fd5b348015610220575f80fd5b506102487f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160801b0390911681526020015b60405180910390f35b348015610270575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b03909116815260200161025c565b3480156102bb575f80fd5b506102487f000000000000000000000000000000000000000000000000000000000000000081565b3480156102ee575f80fd5b506103026102fd366004613a66565b61091a565b6040516001600160e01b0319909116815260200161025c565b348015610326575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b348015610359575f80fd5b5061036261097d565b60405161025c9190613b0a565b34801561037a575f80fd5b50610383610a09565b005b348015610390575f80fd5b50610383610a89565b3480156103a4575f80fd5b506103cc7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160401b03909116815260200161025c565b3480156103ef575f80fd5b506104177f000000000000000000000000000000000000000000000000000000000000000081565b60405162ffffff909116815260200161025c565b348015610436575f80fd5b50610383610dee565b34801561044a575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b34801561047d575f80fd5b5061049161048c366004613b2c565b610fda565b604080516001600160e01b03199094168452602084019290925262ffffff169082015260600161025c565b3480156104c7575f80fd5b506104db6104d6366004613b85565b611044565b604080516001600160e01b0319909316835260208301919091520161025c565b348015610506575f80fd5b5061052e7f000000000000000000000000000000000000000000000000000000000000000081565b604051901515815260200161025c565b348015610549575f80fd5b50610302610558366004613c1d565b6110ae565b348015610568575f80fd5b506105907f000000000000000000000000000000000000000000000000000000000000000081565b60405160029190910b815260200161025c565b3480156105ae575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b3480156105e1575f80fd5b50610383611104565b3480156105f5575f80fd5b505f54610298906001600160a01b031681565b348015610613575f80fd5b506103836112e4565b348015610627575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b34801561065a575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b34801561068d575f80fd5b506106a161069c366004613c76565b6113b6565b604080516001600160e01b03199093168352600f9190910b60208301520161025c565b3480156106cf575f80fd5b506103026106de366004613cf6565b61141e565b3480156106ee575f80fd5b506107d6604080516101c0810182525f80825260208201819052918101829052606081018290526080810182905260a0810182905260c0810182905260e08101829052610100810182905261012081018290526101408101829052610160810182905261018081018290526101a081019190915250604080516101c08101825260018082525f60208301819052928201839052606082018390526080820183905260a0820183905260c082015260e08101829052610100810182905261012081018290526101408101829052610160810182905261018081018290526101a081019190915290565b60405161025c9190613d4f565b3480156107ee575f80fd5b506103cc7f000000000000000000000000000000000000000000000000000000000000000081565b348015610821575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b348015610854575f80fd5b50610302610863366004613e70565b611481565b348015610873575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b3480156108a6575f80fd5b5061052e7f000000000000000000000000000000000000000000000000000000000000000081565b3480156108d9575f80fd5b5060025461052e9060ff1681565b3480156108f2575f80fd5b506102987f000000000000000000000000000000000000000000000000000000000000000081565b5f336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146109645760405163570c108560e11b815260040160405180910390fd5b61097186868686866114e0565b90505b95945050505050565b6001805461098a90613eb7565b80601f01602080910402602001604051908101604052809291908181526020018280546109b690613eb7565b8015610a015780601f106109d857610100808354040283529160200191610a01565b820191905f5260205f20905b8154815290600101906020018083116109e457829003601f168201915b505050505081565b336001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001614610a5257604051632d5be4cb60e21b815260040160405180910390fd5b6002805460ff191660011790556040517fb5c3906b3448ef0ef60eb4570be19d593afecadbccff2f8a7de28d4098aa3f7b905f90a1565b6040516370a0823160e01b81523060048201527f00000000000000000000000000000000000000000000000000000000000000006001600160801b0316907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa158015610b16573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610b3a9190613ee9565b1015610c17576040516370a0823160e01b81523060048201527f0000000000000000000000000000000000000000000000000000000000000000907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa158015610bc4573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610be89190613ee9565b604051631ad2e45b60e21b81526001600160801b03909216600483015260248201526044015b60405180910390fd5b5f610c627f00000000000000000000000000000000000000000000000000000000000000007f0000000000000000000000000000000000000000000000000000000000000000613f14565b60405162ddc14160e21b81529091505f906001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690630377050490610cd9907f00000000000000000000000000000000000000000000000000000000000000009086906001908790600401613f33565b6020604051808303815f875af1158015610cf5573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610d199190614005565b9050610d586001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016826001600160801b0385166114fa565b806001600160a01b031663331f2f656040518163ffffffff1660e01b81526004015f604051808303815f87803b158015610d90575f80fd5b505af1158015610da2573d5f803e3d5ffd5b50505f80546001600160a01b0319166001600160a01b03851690811782556040519093507f8a8cc462d00726e0f8c031dd2d6b9dcdf0794fb27a88579830dadee27d43ea7c9250a25050565b7f00000000000000000000000000000000000000000000000000000000000000006001600160401b0316431015610e6957604051634740621760e11b81526001600160401b037f0000000000000000000000000000000000000000000000000000000000000000166004820152436024820152604401610c0e565b336001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001614610ee3576040516311ce341560e21b81523360048201526001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000166024820152604401610c0e565b5f610f176001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163061159f565b90508015610fd757610f736001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000167f0000000000000000000000000000000000000000000000000000000000000000836114fa565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03167fdd9a81eb1b5197489c3ccfdab7b542e2e6dbdcf4120324e2688fab56fd23f98b82604051610fce91815260200190565b60405180910390a25b50565b5f8080336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146110265760405163570c108560e11b815260040160405180910390fd5b6110338888888888611630565b925092509250955095509592505050565b5f80336001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161461108f5760405163570c108560e11b815260040160405180910390fd5b61109e89898989898989611671565b9150915097509795505050505050565b5f336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146110f85760405163570c108560e11b815260040160405180910390fd5b610974858585856114e0565b7f00000000000000000000000000000000000000000000000000000000000000006001600160401b031643101561117f57604051634740621760e11b81526001600160401b037f0000000000000000000000000000000000000000000000000000000000000000166004820152436024820152604401610c0e565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146111f9576040516311ce341560e21b81523360048201526001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000166024820152604401610c0e565b5f61122d6001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163061159f565b90508015610fd7576112896001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000167f0000000000000000000000000000000000000000000000000000000000000000836114fa565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03167f053dfa7183794b221b03c5109dfb5a07b67d719cb3e98262d48bc66b2a132ad382604051610fce91815260200190565b6112ec61168c565b5f6112f56118d9565b90505f61130182611ca7565b90505f61130d83611ed8565b905061131983826120aa565b8160405161136d919081516001600160a01b03908116825260208084015182169083015260408084015162ffffff169083015260608084015160020b90830152608092830151169181019190915260a00190565b60405190819003812084516001600160a01b03168252907f95cb306ff00e5e11a80ded9ef46c964545cdfb5c889f7f6a0711669d129f120f9060200160405180910390a2505050565b5f80336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146114015760405163570c108560e11b815260040160405180910390fd5b61140f888888888888611671565b91509150965096945050505050565b5f336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146114685760405163570c108560e11b815260040160405180910390fd5b6114768787878787876114e0565b979650505050505050565b5f336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146114cb5760405163570c108560e11b815260040160405180910390fd5b6114d68484846122b7565b90505b9392505050565b5f604051630a85dc2960e01b815260040160405180910390fd5b5f6001600160a01b03841661152f575f805f8085875af190508061152a5761152a835f633d2cec6f60e21b612302565b611599565b60405163a9059cbb60e01b81526001600160a01b038416600482015282602482015260205f6044835f895af13d15601f3d1160015f511416171691505f81525f60208201525f60408201525080611599576115998463a9059cbb60e01b633c9fd93960e21b612302565b50505050565b5f6001600160a01b0383166115bf57506001600160a01b0381163161162a565b6040516370a0823160e01b81526001600160a01b0383811660048301528416906370a0823190602401602060405180830381865afa158015611603573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906116279190613ee9565b90505b92915050565b6002545f908190819060ff1661165957604051637657d18960e01b815260040160405180910390fd5b506315d7892d60e21b975f9750879650945050505050565b5f80604051630a85dc2960e01b815260040160405180910390fd5b7f00000000000000000000000000000000000000000000000000000000000000006001600160401b03164310156117075760405163a06fc0c960e01b81526001600160401b037f0000000000000000000000000000000000000000000000000000000000000000166004820152436024820152604401610c0e565b5f8054906101000a90046001600160a01b03166001600160a01b031663c2c4c5c16040518163ffffffff1660e01b815260040160c0604051808303815f875af1158015611756573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061177a919061405c565b505f805f9054906101000a90046001600160a01b03166001600160a01b031663998ba4fc6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156117cb573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906117ef9190613ee9565b90506001600160801b0381111561182957604051634defa31760e01b8152600481018290526001600160801b036024820152604401610c0e565b805f03611849576040516310ef230360e11b815260040160405180910390fd5b8061187d6001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163061159f565b1015610fd757806118b76001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163061159f565b604051632bcaebd360e01b815260048101929092526024820152604401610c0e565b6040805160e0810182525f8082526020808301829052828401829052606083018290526080830182905260a0830182905260c0830182905281548451632662e93f60e21b81529451939492936001600160a01b039091169263998ba4fc9260048083019391928290030181865afa158015611956573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061197a9190613ee9565b90505f7f000000000000000000000000000000000000000000000000000000000000000090505f611a51826001600160a01b03167f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316105f8054906101000a90046001600160a01b03166001600160a01b03166332a0f2d76040518163ffffffff1660e01b8152600401602060405180830381865afa158015611a27573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611a4b9190613ee9565b9061237a565b9050611a5c81612441565b6001600160a01b039081168552611abf90829085908581167f0000000000000000000000000000000000000000000000000000000000000000909116107f00000000000000000000000000000000000000000000000000000000000000006124d8565b6001600160801b03908116606088015290811660408701521660208501528351611be990611b14611b0f7f00000000000000000000000000000000000000000000000000000000000000006125be565b6125df565b611b40611b0f7f0000000000000000000000000000000000000000000000000000000000000000612897565b856001600160a01b03167f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031610611b83578760200151611b89565b87606001515b6001600160801b0316866001600160a01b03167f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031610611bd5578860600151611bdb565b88602001515b6001600160801b03166128af565b6001600160801b031660808501527f00000000000000000000000000000000000000000000000000000000000000008015611c59575083602001516001600160801b03167f00000000000000000000000000000000000000000000000000000000000000006001600160801b0316115b80611c9857507f00000000000000000000000000000000000000000000000000000000000000008015611c9857505f84604001516001600160801b0316115b151560a0850152509192915050565b6040805160a0810182525f808252602082018190529181018290526060810182905260808101829052907f000000000000000000000000000000000000000000000000000000000000000090506040518060a00160405280826001600160a01b03167f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031610611d3e5782611d60565b7f00000000000000000000000000000000000000000000000000000000000000005b6001600160a01b03168152602001826001600160a01b03167f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031610611dcd577f0000000000000000000000000000000000000000000000000000000000000000611dcf565b825b6001600160a01b031681526020017f000000000000000000000000000000000000000000000000000000000000000062ffffff1681526020017f000000000000000000000000000000000000000000000000000000000000000060020b8152602001306001600160a01b031681525091507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316636276cbbe83855f01516040518363ffffffff1660e01b8152600401611e91929190614134565b6020604051808303815f875af1158015611ead573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611ed1919061415a565b5050919050565b606080805f7f000000000000000000000000000000000000000000000000000000000000000090505f6040518061010001604052807f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001836001600160a01b031681526020017f000000000000000000000000000000000000000000000000000000000000000062ffffff1681526020017f000000000000000000000000000000000000000000000000000000000000000060020b8152602001875f01516001600160a01b0316815260200187608001516001600160801b031681526020017f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001306001600160a01b031681525090508560a00151156120525761202181876020015188606001516005612964565b809450819550505061203e81858589602001518a604001516129a1565b805160051460c0890152909450925061206d565b61206781876020015188606001516004612964565b90945092505b612078818585612a27565b60405191955093506120909085908590602001614175565b604051602081830303815290604052945050505050919050565b5f6120b483612a41565b90506121136001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000167f00000000000000000000000000000000000000000000000000000000000000006001600160801b0384166114fa565b5f61211d84612abd565b90506001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000166121d95760405163dd46508f60e01b81526001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000169063dd46508f906001600160801b038416906121a690879042906004016141ea565b5f604051808303818588803b1580156121bd575f80fd5b505af11580156121cf573d5f803e3d5ffd5b5050505050611599565b6122366001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000167f00000000000000000000000000000000000000000000000000000000000000006001600160801b0384166114fa565b60405163dd46508f60e01b81526001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000169063dd46508f9061228490869042906004016141ea565b5f604051808303815f87803b15801561229b575f80fd5b505af11580156122ad573d5f803e3d5ffd5b5050505050505050565b5f6001600160a01b03841630146122f257604051638cbcc02560e01b81526001600160a01b0385166004820152306024820152604401610c0e565b50636e4c1aa760e11b9392505050565b6040516390bfb86560e01b8082526001600160a01b03851660048301526001600160e01b031984166024830152608060448301526020601f3d018190040260a0810160648401523d608484015290913d5f60a483013e60048260a4018201526001600160e01b031984168260c4018201528160e40181fd5b5f825f0361239e5760405163d173d09f60e01b815260048101849052602401610c0e565b81156124065760a06123b484600160c01b61421f565b901c156123f3576123c983600160c01b61421f565b6040516387ebe85d60e01b815260048101919091526001600160a01b036024820152604401610c0e565b611627600160c01b600160601b85612afd565b60a083901c15612439576040516387ebe85d60e01b8152600481018490526001600160a01b036024820152604401610c0e565b505060601b90565b5f61244b82612b99565b90506401000276a36001600160a01b0382161080612485575073fffd8963efd1fc6a506488495d951d5263988d266001600160a01b038216115b156124d357604051633393dca160e11b81526001600160a01b03821660048201526401000276a3602482015273fffd8963efd1fc6a506488495d951d5263988d266044820152606401610c0e565b919050565b5f805f80856124fe576124f9876001600160801b0316600160c01b8a612afd565b612516565b61251688886001600160801b0316600160c01b612afd565b9050846001600160801b03168111156125ac575f8661254c5761254789876001600160801b0316600160c01b612afd565b612564565b612564866001600160801b0316600160c01b8b612afd565b90506001600160801b0381111561259457604051600162d630f360e01b0319815260048101829052602401610c0e565b9150816125a18189613f14565b9350859450506125b3565b8691508093505b509450945094915050565b5f81600281900b620d89e719816125d7576125d761420b565b050292915050565b60020b5f60ff82901d80830118620d89e8811115612608576126086345c3193d60e11b84612cf1565b7001fffcb933bd6fad37aa2d162d1a5940016001821602600160801b186002821615612644576ffff97272373d413259a46990580e213a0260801c5b6004821615612663576ffff2e50f5f656932ef12357cf3c7fdcc0260801c5b6008821615612682576fffe5caca7e10e4e61c3624eaa0941cd00260801c5b60108216156126a1576fffcb9843d60f6159c9db58835c9266440260801c5b60208216156126c0576fff973b41fa98c081472e6896dfb254c00260801c5b60408216156126df576fff2ea16466c96a3843ec78b326b528610260801c5b60808216156126fe576ffe5dee046a99a2a811c461f1969c30530260801c5b61010082161561271e576ffcbe86c7900a88aedcffc83b479aa3a40260801c5b61020082161561273e576ff987a7253ac413176f2b074cf7815e540260801c5b61040082161561275e576ff3392b0822b70005940c7a398e4b70f30260801c5b61080082161561277e576fe7159475a2c29b7443b29c7fa6e889d90260801c5b61100082161561279e576fd097f3bdfd2022b8845ad8f792aa58250260801c5b6120008216156127be576fa9f746462d870fdf8a65dc1f90e061e50260801c5b6140008216156127de576f70d869a156d2a1b890bb3df62baf32f70260801c5b6180008216156127fe576f31be135f97d08fd981231505542fcfa60260801c5b6201000082161561281f576f09aa508b5b7a84e1c677de54f3e99bc90260801c5b6202000082161561283f576e5d6af8dedb81196699c329225ee6040260801c5b6204000082161561285e576d2216e584f5fa1ea926041bedfe980260801c5b6208000082161561287b576b048a170391f7dc42444e8fa20260801c5b5f841315612887575f19045b63ffffffff0160201c9392505050565b5f81600281900b620d89e8816125d7576125d761420b565b5f836001600160a01b0316856001600160a01b031611156128ce579293925b846001600160a01b0316866001600160a01b0316116128f9576128f2858585612d00565b9050610974565b836001600160a01b0316866001600160a01b03161015612959575f61291f878686612d00565b90505f61292d878986612d61565b9050806001600160801b0316826001600160801b03161061294e5780612950565b815b92505050610974565b610971858584612d61565b604080518082019091526001600160801b038085168252831660208201526060908190612992878286612d9d565b92509250505b94509492505050565b6060805f80846001600160801b0316116129e4576129df857f0000000000000000000000000000000000000000000000000000000000000000613f14565b6129e6565b835b604080518082019091526001600160801b03808316825286161560208201819052919250612a168a828b8b612edb565b945094505050509550959350505050565b606080612a35858585613108565b91509150935093915050565b5f81602001516001600160801b03167f00000000000000000000000000000000000000000000000000000000000000006001600160801b0316118015612a8857508160c001515b612a9657816020015161162a565b7f000000000000000000000000000000000000000000000000000000000000000092915050565b5f8082604001516001600160801b0316118015612adb57508160c001515b612ae957816060015161162a565b8160400151826060015161162a919061423e565b5f838302815f1985870982811083820303915050808411612b1c575f80fd5b805f03612b2e575082900490506114d9565b5f848688095f868103871696879004966002600389028118808a02820302808a02820302808a02820302808a02820302808a02820302808a02909103029181900381900460010186841190950394909402919094039290920491909117919091029150509392505050565b5f60018211612ba6575090565b816001600160801b8210612bbf5760809190911c9060401b5b680100000000000000008210612bda5760409190911c9060201b5b6401000000008210612bf15760209190911c9060101b5b620100008210612c065760109190911c9060081b5b6101008210612c1a5760089190911c9060041b5b60108210612c2d5760049190911c9060021b5b60048210612c395760011b5b600302600190811c90818581612c5157612c5161420b565b048201901c90506001818581612c6957612c6961420b565b048201901c90506001818581612c8157612c8161420b565b048201901c90506001818581612c9957612c9961420b565b048201901c90506001818581612cb157612cb161420b565b048201901c90506001818581612cc957612cc961420b565b048201901c9050612ce8818581612ce257612ce261420b565b04821190565b90039392505050565b815f528060020b60045260245ffd5b5f826001600160a01b0316846001600160a01b03161115612d1f579192915b5f612d41856001600160a01b0316856001600160a01b0316600160601b612afd565b9050610974612d5c84838888036001600160a01b0316612afd565b613165565b5f826001600160a01b0316846001600160a01b03161115612d80579192915b6114d6612d5c83600160601b8787036001600160a01b0316612afd565b6060805f85602001516001600160a01b0316865f01516001600160a01b03161090505f6040518060400160405280612dd889606001516125be565b60020b8152602001612ded8960600151612897565b60020b81525090505f6040518060a0016040528084612e10578960200151612e13565b89515b6001600160a01b0316815260200184612e2d578951612e33565b89602001515b6001600160a01b03168152602001896040015162ffffff168152602001896060015160020b81526020018960e001516001600160a01b03168152509050612ea760408051600160f91b6020820152600b60f81b60218201819052602282015281516003818303018152602390910190915290565b9450612ece818385898c60c001518d60a001518d613186909695949392919063ffffffff16565b9350505050935093915050565b6060805f86602001516001600160a01b0316875f01516001600160a01b03161090505f8660200151151582151514612f2457612f1f8860800151896060015161335e565b612f36565b612f36886080015189606001516133dc565b805190915060020b158015612f505750602081015160020b155b15612f65575050600483525082905081612998565b5f612fcd8960800151612f7a845f01516125df565b612f8785602001516125df565b8b60200151151587151514612f9d578b51612f9f565b5f5b6001600160801b03168c60200151151588151514612fbd575f611bdb565b8c516001600160801b03166128af565b90506001600160801b0381161580613042575061301e896060015160020b5f60029190910b620d89e719818107929092129181900591909103620d89e891909105036001016001600160801b030490565b6001600160801b0316818a60a00151613037919061423e565b6001600160801b0316115b156130595760048652868694509450505050612998565b5f6040518060a0016040528085613074578b60200151613077565b8b515b6001600160a01b0316815260200185613091578b51613097565b8b602001515b6001600160a01b031681526020018b6040015162ffffff1681526020018b6060015160020b81526020018b60e001516001600160a01b031681525090506130dd8861344f565b60c08b01519096506130f9908a908390869088908c90886134ac565b94505050505094509492505050565b6020830151835160609182916001600160a01b0391821691161061312b85613589565b925061315a8161313f578660200151613142565b86515b8261314e578751613154565b87602001515b8661359f565b915050935093915050565b806001600160801b03811681146124d3576124d36393dafdf160e01b61363e565b60606004841415801561319a575060058414155b156131bb57604051631e1a3c5b60e01b815260048101859052602401610c0e565b836001600160401b038111156131d3576131d3614020565b60405190808252806020026020018201604052801561320657816020015b60608152602001906001900390816131f15790505b5090505f8561321657885161321c565b88602001515b90505f8661322e578960200151613231565b89515b88516020808b0151604080515f8152928301815293945061325f938d93928991889188918d9190810161425d565b604051602081830303815290604052835f81518110613280576132806142dd565b6020908102919091018101919091528951604080516001600160a01b0390921692820192909252600160ff1b918101919091525f6060820152608001604051602081830303815290604052836001815181106132de576132de6142dd565b60200260200101819052508860200151600160ff1b5f604051602001613324939291906001600160a01b0393909316835260208301919091521515604082015260600190565b60405160208183030381529060405283600281518110613346576133466142dd565b60200260200101819052505050979650505050505050565b604080518082019091525f80825260208201525f61337b84613646565b9050600283900b61338f82620d89e86142f1565b60020b1361339d575061162a565b60405180604001604052806133be858460020b6138d690919063ffffffff16565b60020b81526020016133cf85612897565b60020b9052949350505050565b604080518082019091525f80825260208201525f6133f984613646565b9050600283900b61340e620d89e719836142f1565b60020b121561341d575061162a565b6040518060400160405280613431856125be565b60020b81526020016133cf858460020b61391190919063ffffffff16565b606061345d60016004614316565b8251146134825781516040516311d8e0a760e11b8152600401610c0e91815260200190565b816002604051602001613496929190614329565b6040516020818303038152906040529050919050565b606060058451146134d5578351604051631e1a3c5b60e01b8152600401610c0e91815260200190565b60208801511515851515145f816134ed5789516134ef565b5f5b6001600160801b031690505f82613506575f613509565b8a515b89516020808c0151604080515f815292830181526001600160801b03949094169450613542938e93928a91889188918e91908101614353565b60408051601f198184030181529190528761355f60016004614316565b8151811061356f5761356f6142dd565b602090810291909101015250949998505050505050505050565b6060816011604051602001613496929190614329565b606060048251141580156135b557506005825114155b156135d8578151604051631e1a3c5b60e01b8152600401610c0e91815260200190565b604080516001600160a01b038087166020830152851691810191909152306060820152608001604051602081830303815290604052826001845161361c9190614316565b8151811061362c5761362c6142dd565b60209081029190910101525092915050565b805f5260045ffd5b5f73fffd8963efd1fc6a506488495d951d51639616826401000276a21983016001600160a01b03161115613685576136856318521d4960e21b83613949565b640100000000600160c01b03602083901b16805f6136a28261395e565b60ff169050608081106136bd57607f810383901c91506136c7565b80607f0383901b91505b908002607f81811c60ff83811c9190911c800280831c81831c1c800280841c81841c1c800280851c81851c1c800280861c81861c1c800280871c81871c1c800280881c81881c1c800280891c81891c1c8002808a1c818a1c1c8002808b1c818b1c1c8002808c1c818c1c1c8002808d1c818d1c1c8002808e1c9c81901c9c909c1c80029c8d901c9e9d607f198f0160401b60c09190911c678000000000000000161760c19b909b1c674000000000000000169a909a1760c29990991c672000000000000000169890981760c39790971c671000000000000000169690961760c49590951c670800000000000000169490941760c59390931c670400000000000000169290921760c69190911c670200000000000000161760c79190911c670100000000000000161760c89190911c6680000000000000161760c99190911c6640000000000000161760ca9190911c6620000000000000161760cb9190911c6610000000000000161760cc9190911c6608000000000000161760cd9190911c66040000000000001617693627a301d71055774c8581026f028f6481ab7f045a5af012a19d003aa9198101608090811d906fdb2df09e81959a81455e260799a0632f8301901d600281810b9083900b146138c757886001600160a01b03166138ac826125df565b6001600160a01b031611156138c157816138c9565b806138c9565b815b9998505050505050505050565b5f808260020b8460020b816138ed576138ed61420b565b0790505f8160020b121561390357808403613909565b80838501035b949350505050565b5f808260020b8460020b816139285761392861420b565b0790505f8160020b1215613940578281850303613909565b90920392915050565b815f526001600160a01b03811660045260245ffd5b5f80821161396a575f80fd5b507f0706060506020500060203020504000106050205030304010505030400000000601f6f8421084210842108cc6318c6db6d54be6001600160801b03841160071b84811c6001600160401b031060061b1784811c63ffffffff1060051b1784811c61ffff1060041b1784811c60ff1060031b1793841c1c161a1790565b6001600160a01b0381168114610fd7575f80fd5b5f60a08284031215613a0c575f80fd5b50919050565b5f60808284031215613a0c575f80fd5b5f8083601f840112613a32575f80fd5b5081356001600160401b03811115613a48575f80fd5b602083019150836020828501011115613a5f575f80fd5b9250929050565b5f805f805f6101608688031215613a7b575f80fd5b8535613a86816139e8565b9450613a9587602088016139fc565b9350613aa48760c08801613a12565b92506101408601356001600160401b03811115613abf575f80fd5b613acb88828901613a22565b969995985093965092949392505050565b5f81518084528060208401602086015e5f602082860101526020601f19601f83011685010191505092915050565b602081525f6114d96020830184613adc565b5f60608284031215613a0c575f80fd5b5f805f805f6101408688031215613b41575f80fd5b8535613b4c816139e8565b9450613b5b87602088016139fc565b9350613b6a8760c08801613b1c565b92506101208601356001600160401b03811115613abf575f80fd5b5f805f805f805f6101a0888a031215613b9c575f80fd5b8735613ba7816139e8565b9650613bb68960208a016139fc565b9550613bc58960c08a01613a12565b9450610140880135935061016088013592506101808801356001600160401b03811115613bf0575f80fd5b613bfc8a828b01613a22565b989b979a50959850939692959293505050565b8060020b8114610fd7575f80fd5b5f805f806101008587031215613c31575f80fd5b8435613c3c816139e8565b9350613c4b86602087016139fc565b925060c0850135613c5b816139e8565b915060e0850135613c6b81613c0f565b939692955090935050565b5f805f805f806101608789031215613c8c575f80fd5b8635613c97816139e8565b9550613ca688602089016139fc565b9450613cb58860c08901613b1c565b935061012087013592506101408701356001600160401b03811115613cd8575f80fd5b613ce489828a01613a22565b979a9699509497509295939492505050565b5f805f805f806101208789031215613d0c575f80fd5b8635613d17816139e8565b9550613d2688602089016139fc565b945060c0870135935060e087013592506101008701356001600160401b03811115613cd8575f80fd5b8151151581526101c081016020830151613d6d602084018215159052565b506040830151613d81604084018215159052565b506060830151613d95606084018215159052565b506080830151613da9608084018215159052565b5060a0830151613dbd60a084018215159052565b5060c0830151613dd160c084018215159052565b5060e0830151613de560e084018215159052565b50610100830151613dfb61010084018215159052565b50610120830151613e1161012084018215159052565b50610140830151613e2761014084018215159052565b50610160830151613e3d61016084018215159052565b50610180830151613e5361018084018215159052565b506101a0830151613e696101a084018215159052565b5092915050565b5f805f60e08486031215613e82575f80fd5b8335613e8d816139e8565b9250613e9c85602086016139fc565b915060c0840135613eac816139e8565b809150509250925092565b600181811c90821680613ecb57607f821691505b602082108103613a0c57634e487b7160e01b5f52602260045260245ffd5b5f60208284031215613ef9575f80fd5b5051919050565b634e487b7160e01b5f52601160045260245ffd5b6001600160801b03828116828216039081111561162a5761162a613f00565b6001600160a01b03851681526001600160801b03841660208201526080604082015282545f908190600181811c90821680613f6f57607f821691505b602082108103613f8d57634e487b7160e01b5f52602260045260245ffd5b6080860182905260a08601818015613fac5760018114613fc257613fee565b60ff198516825283151560051b82019550613fee565b5f8a8152602090205f5b85811015613fe857815484820152600190910190602001613fcc565b83019650505b505050505060609290920192909252949350505050565b5f60208284031215614015575f80fd5b81516114d9816139e8565b634e487b7160e01b5f52604160045260245ffd5b805162ffffff811681146124d3575f80fd5b80516001600160401b03811681146124d3575f80fd5b5f60c082840312801561406d575f80fd5b5060405160c081016001600160401b038111828210171561409c57634e487b7160e01b5f52604160045260245ffd5b6040908152835182526020808501519083015283810151908201526140c360608401614034565b60608201526140d460808401614046565b60808201526140e560a08401614046565b60a08201529392505050565b80516001600160a01b03908116835260208083015182169084015260408083015162ffffff169084015260608083015160020b9084015260809182015116910152565b60c0810161414282856140f1565b6001600160a01b039290921660a09190910152919050565b5f6020828403121561416a575f80fd5b81516114d981613c0f565b604081525f6141876040830185613adc565b828103602084015280845180835260208301915060208160051b840101602087015f5b838110156141dc57601f198684030185526141c6838351613adc565b60209586019590935091909101906001016141aa565b509098975050505050505050565b604081525f6141fc6040830185613adc565b90508260208301529392505050565b634e487b7160e01b5f52601260045260245ffd5b5f8261423957634e487b7160e01b5f52601260045260245ffd5b500490565b6001600160801b03818116838216019081111561162a5761162a613f00565b614267818a6140f1565b8760020b60a08201528660020b60c08201526001600160801b03861660e08201526001600160801b0385166101008201526001600160801b03841661012082015260018060a01b0383166101408201526101806101608201525f6142cf610180830184613adc565b9a9950505050505050505050565b634e487b7160e01b5f52603260045260245ffd5b600282810b9082900b03627fffff198112627fffff8213171561162a5761162a613f00565b8181038181111561162a5761162a613f00565b5f83518060208601845e60f89390931b6001600160f81b0319169190920190815260010192915050565b61435d818a6140f1565b8760020b60a08201528660020b60c08201526001600160801b03861660e0820152846101008201528361012082015260018060a01b0383166101408201526101806101608201525f6142cf610180830184613adc56fea164736f6c634300081a000a';

            console2.log("About to calculate initCodeHash");
            StrategyConfiguration memory strategyConfiguration = CONFIGURATION.getStrategyConfiguration();
            bytes32 initCodeHash = keccak256(
                abi.encodePacked(
                    // type(VirtualLBPStrategyBasic).creationCode,
                    virtualLBPStrategyBasicCreationCode,
                    abi.encode(
                        deployedContracts.virtualAztecToken,
                        tokenSplits.totalSupply,
                        uniParams.migratorParams,
                        abi.encode(uniParams.auctionParams),
                        strategyConfiguration.positionManager,
                        strategyConfiguration.poolManager,
                        deployedContracts.dateGatedRelayerShort
                    )
                )
            );
            deployedContracts.generatedSalt = new SaltGenerator().withInitCodeHash(initCodeHash).withMask(
                strategyConfiguration.hookMask
            ).withMsgSender(address(deployedContracts.foundationPayload)).withTokenLauncher(
                address(deployedContracts.tokenLauncher)
            ).withStrategyFactoryAddress(address(deployedContracts.virtualLBPFactory)).generate();

            // Predict the auction address

            vm.prank(deployedContracts.foundationPayload);
            deployedContracts.predictedVirtualLBPAddress = IVirtualLBPStrategyFactory(
                deployedContracts.virtualLBPFactory
            ).getVirtualLBPAddress(
                address(deployedContracts.virtualAztecToken),
                tokenSplits.totalSupply,
                uniParams.distributionParams.configData,
                keccak256(abi.encode(address(deployedContracts.foundationPayload), deployedContracts.generatedSalt)),
                address(deployedContracts.tokenLauncher) // sender
            );
            uniParams.auctionParams.fundsRecipient = deployedContracts.predictedVirtualLBPAddress;

            // Set the auction address on the auction hook - must prank to msg.sender as the auction factory uses msg.sender in the salt
            vm.prank(deployedContracts.foundationPayload);
            deployedContracts.auction = IContinuousClearingAuctionFactory(deployedContracts.auctionFactory)
                .getAuctionAddress(
                address(deployedContracts.virtualAztecToken),
                tokenSplits.auctionTotalSupply,
                abi.encode(uniParams.auctionParams),
                bytes32(0),
                address(deployedContracts.predictedVirtualLBPAddress)
            );
        }

        {
            // Set the auction address on the auction hook - before deploying the auction contract - we want to do this as soon as possible
            vm.broadcast(WALLETS.deployer);
            AztecAuctionHook(deployedContracts.auctionHook).setAuction(
                IContinuousClearingAuction(deployedContracts.auction)
            );

            // Set the auction address on the virtual aztec token
            vm.broadcast(WALLETS.deployer);
            VirtualAztecToken(deployedContracts.virtualAztecToken).setAuctionAddress(
                IContinuousClearingAuction(deployedContracts.auction)
            );
            vm.broadcast(WALLETS.deployer);
            VirtualAztecToken(deployedContracts.virtualAztecToken).setStrategyAddress(
                deployedContracts.predictedVirtualLBPAddress
            );

            // Set the auction address screening provider on the auction hook
            vm.broadcast(WALLETS.deployer);
            VirtualAztecToken(deployedContracts.virtualAztecToken).setScreeningProvider(
                address(predicateAuctionScreeningProvider)
            );
        }

        // Make the virtual aztec token a minter of the ATP factories
        {
            vm.broadcast(WALLETS.deployer);
            ATPFactoryNonces(deployedContracts.atpFactoryAuction).setMinter(
                address(deployedContracts.virtualAztecToken), true
            );
        }

        // We hand over the virtual aztec token to the FoundationPayload, and when executed it will deploy the
        // auction as well.
        vm.startBroadcast(WALLETS.deployer);
        Ownable(deployedContracts.virtualAztecToken).transferOwnership(deployedContracts.foundationPayload);
        Ownable(deployedContracts.atpRegistryAuction).transferOwnership(deployedContracts.foundationPayload);
        Ownable(deployedContracts.auctionHook).transferOwnership(WALLETS.lowValueOwner);
        Ownable(deployedContracts.predicateAuctionScreeningProvider).transferOwnership(WALLETS.lowValueOwner);

        Ownable(deployedContracts.atpFactoryAuction).renounceOwnership();
        vm.stopBroadcast();
    }

    function assertions() public {
        _assertPredicateAuctionScreeningProviderConfiguration();
        _assertATPFactoryConfiguration();
        _assertAtpRegistryConfiguration();
        _assertVirtualAztecTokenConfiguration();

        assertEq(
            StakerVersion.unwrap(ATPFactory(deployedContracts.atpFactoryAuction).getRegistry().getNextStakerVersion()),
            2,
            "Stake implementation count mismatch"
        );
    }

    function _assertPredicateAuctionScreeningProviderConfiguration() internal {
        PredicateConfiguration memory predicateConfiguration = CONFIGURATION.getPredicateConfiguration();
        PredicateProvider predicateAuctionScreeningProvider =
            PredicateProvider(deployedContracts.predicateAuctionScreeningProvider);

        assertEq(predicateAuctionScreeningProvider.consumer(), address(deployedContracts.virtualAztecToken));
        assertEq(predicateAuctionScreeningProvider.getPolicy(), predicateConfiguration.addressScreeningPolicyId);
        assertEq(predicateAuctionScreeningProvider.getPredicateManager(), predicateConfiguration.managerAddress);

        // @todo Owner
        if (CHAIN_ENVIRONMENT == ChainEnvironment.FORKED_MAINNET) {
            return;
        }
        assertEq(predicateAuctionScreeningProvider.owner(), WALLETS.lowValueOwner);
    }

    function _assertATPFactoryConfiguration() internal {
        AtpFactoryConfiguration memory atpFactoryConfiguration = CONFIGURATION.getAtpFactoryConfiguration();
        ATPFactory atpFactory = ATPFactory(deployedContracts.atpFactoryAuction);

        assertEq(atpFactory.minter(address(deployedContracts.virtualAztecToken)), true);

        // WARN: Potential danger if controlled by anyone, ensure it is renounced.
        assertEq(atpFactory.owner(), address(0));
        assertEq(atpFactory.pendingOwner(), address(0));
    }

    function _assertAtpRegistryConfiguration() internal {
        AtpFactoryConfiguration memory atpConfiguration = CONFIGURATION.getAtpFactoryConfiguration();
        IRegistry atpRegistry = IRegistry(address(ATPFactory(deployedContracts.atpFactoryAuction).getRegistry()));

        assertEq(atpRegistry.getGlobalLockParams().cliffDuration, atpConfiguration.unlockCliffDuration);
        assertEq(atpRegistry.getGlobalLockParams().lockDuration, atpConfiguration.unlockLockDuration);
        assertEq(atpRegistry.getExecuteAllowedAt(), atpConfiguration.executionAllowedAt);
        assertEq(StakerVersion.unwrap(atpRegistry.getNextStakerVersion()), 2);
        assertEq(
            atpRegistry.getStakerImplementation(StakerVersion.wrap(1)),
            address(deployedContracts.atpWithdrawableAndClaimableStaker)
        );

        // NOTE: Must be pending for the foundation payload, otherwise it cannot execute.
        assertEq(Ownable(address(atpRegistry)).owner(), WALLETS.deployer);
        assertEq(Ownable2Step(address(atpRegistry)).pendingOwner(), deployedContracts.foundationPayload);
    }

    function _assertVirtualAztecTokenConfiguration() internal {
        VirtualAztecTokenConfiguration memory virtualAztecTokenConfiguration =
            CONFIGURATION.getVirtualAztecTokenConfiguration();

        VirtualAztecToken virtualAztecToken = VirtualAztecToken(deployedContracts.virtualAztecToken);

        assertEq(virtualAztecToken.name(), virtualAztecTokenConfiguration.name);
        assertEq(virtualAztecToken.symbol(), virtualAztecTokenConfiguration.symbol);

        assertEq(virtualAztecToken.FOUNDATION_ADDRESS(), WALLETS.twapTokenRecipient);

        assertEq(address(virtualAztecToken.UNDERLYING_TOKEN_ADDRESS()), deployedContracts.stakingAssetAddress);
        assertEq(address(virtualAztecToken.ATP_FACTORY()), deployedContracts.atpFactoryAuction);

        assertEq(address(virtualAztecToken.auctionAddress()), deployedContracts.auction);
        assertEq(virtualAztecToken.strategyAddress(), deployedContracts.predictedVirtualLBPAddress);

        // @note no getter, so we read the storage directly.
        // virtualAztecToken.screeningProvider() == deployedContracts.predicateAuctionScreeningProvider);
        address screeningProvider = address(uint160(uint256(vm.load(address(virtualAztecToken), bytes32(uint256(11))))));
        assertEq(screeningProvider, deployedContracts.predicateAuctionScreeningProvider);

        assertEq(virtualAztecToken.owner(), address(deployedContracts.foundationPayload));
    }

    function assertTokenSplits() public {
        // NOTE: Will be executed AFTER the foundation payload where funds are moved around.

        TokenSplits memory ts = CONFIGURATION.getTokenSplits();
        IERC20 token = IERC20(deployedContracts.stakingAssetAddress);
        IERC20 vToken = IERC20(deployedContracts.virtualAztecToken);

        assertEq(vToken.balanceOf(deployedContracts.auction), ts.auctionTotalSupply);
        assertEq(vToken.balanceOf(deployedContracts.predictedVirtualLBPAddress), ts.reserveSupply);
        assertEq(token.balanceOf(address(vToken)), ts.totalSupply);
    }
}
